{
  "name": "Agent Alternance - Avec Fichier Excel",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "cronExpression": "*/15 * * * *"
            }
          ]
        }
      },
      "id": "cron-trigger-excel",
      "name": "D√©clencheur Test (15min)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [240, 240]
    },
    {
      "parameters": {
        "functionCode": "// G√©n√©rateur de donn√©es enrichies pour Excel\nconst offers = [\n  {\n    title: \"Alternance Cybers√©curit√© - Analyste SOC H/F\",\n    company: \"SecureTech Solutions\",\n    location: \"Paris (75)\",\n    duration: \"24 mois\",\n    start_date: \"septembre 2025\",\n    description: \"Recherchons alternant pour poste d'analyste SOC. Formation cybers√©curit√© Master 1/2. Missions: monitoring s√©curit√©, analyse incidents, reporting.\",\n    url: \"https://pole-emploi.fr/candidat/offres/recherche/detail/123456\",\n    scraper_source: \"pole_emploi\",\n    ai_response: \"VALIDE\",\n    is_valid: true,\n    status: \"‚úÖ VALID√âE\",\n    processed_at: new Date().toISOString()\n  },\n  {\n    title: \"Formation Cybers√©curit√© - √âcole Sup√©rieure\",\n    company: \"√âcole Sup√©rieure Informatique\",\n    location: \"Lyon (69)\",\n    duration: \"3 ans\",\n    start_date: \"septembre 2025\",\n    description: \"Formation dipl√¥mante en cybers√©curit√©. Programme complet th√©orique avec stages en entreprise.\",\n    url: \"https://indeed.fr/formation/cybersecurite-123\",\n    scraper_source: \"indeed\",\n    ai_response: \"INVALIDE: Formation d'√©cole\",\n    is_valid: false,\n    status: \"‚ùå REJET√âE\",\n    processed_at: new Date().toISOString()\n  },\n  {\n    title: \"Alternance DevSecOps - Infrastructure S√©curis√©e\",\n    company: \"TechCorp Enterprise\",\n    location: \"Marseille (13)\",\n    duration: \"18 mois\",\n    start_date: \"septembre 2025\",\n    description: \"Poste d'alternant DevSecOps. Mission: automatisation s√©curit√©, CI/CD s√©curis√©, audit infrastructure.\",\n    url: \"https://apec.fr/candidat/recherche-emploi/detail/123789\",\n    scraper_source: \"apec\",\n    ai_response: \"VALIDE\",\n    is_valid: true,\n    status: \"‚úÖ VALID√âE\",\n    processed_at: new Date().toISOString()\n  },\n  {\n    title: \"Alternance Pentester Junior - Audit S√©curit√©\",\n    company: \"CyberSec Consulting\",\n    location: \"Toulouse (31)\",\n    duration: \"24 mois\",\n    start_date: \"octobre 2025\",\n    description: \"Alternance pentesting et audit s√©curit√©. Formation sur tests d'intrusion, analyse vuln√©rabilit√©s.\",\n    url: \"https://linkedin.com/jobs/view/987654321\",\n    scraper_source: \"linkedin\",\n    ai_response: \"VALIDE\",\n    is_valid: true,\n    status: \"‚úÖ VALID√âE\",\n    processed_at: new Date().toISOString()\n  },\n  {\n    title: \"Alternance RSSI Junior - Gouvernance S√©curit√©\",\n    company: \"Digital Security Corp\",\n    location: \"Nantes (44)\",\n    duration: \"24 mois\",\n    start_date: \"janvier 2026\",\n    description: \"Alternance en gouvernance s√©curit√©. Missions: politique s√©curit√©, conformit√© RGPD, formation utilisateurs.\",\n    url: \"https://monster.fr/emploi/alternance-rssi-123456\",\n    scraper_source: \"monster\",\n    ai_response: \"VALIDE\",\n    is_valid: true,\n    status: \"‚úÖ VALID√âE\",\n    processed_at: new Date().toISOString()\n  }\n];\n\nconsole.log(`üìã G√©n√©ration de ${offers.length} offres pour Excel`);\nconsole.log(`‚úÖ Offres valid√©es: ${offers.filter(o => o.is_valid).length}`);\nconsole.log(`‚ùå Offres rejet√©es: ${offers.filter(o => !o.is_valid).length}`);\n\nreturn offers.map(offer => ({ json: offer }));"
      },
      "id": "data-enriched",
      "name": "Donn√©es Enrichies",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 240]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.is_valid }}",
              "value2": true
            }
          ]
        }
      },
      "id": "filter-valid-only",
      "name": "Filtrer Valid√©es",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 240]
    },
    {
      "parameters": {
        "functionCode": "// Formatage pour Excel\nconst offer = $json;\nconst timestamp = new Date().toLocaleDateString('fr-FR');\n\n// Donn√©es format√©es pour Excel\nconst excelRow = {\n  'N¬∞': 1, // Sera r√©ajust√© apr√®s agr√©gation\n  'Titre': offer.title || 'N/A',\n  'Entreprise': offer.company || 'N/A',\n  'Localisation': offer.location || 'N/A',\n  'Dur√©e': offer.duration || 'N/A',\n  'Date de d√©but': offer.start_date || 'N/A',\n  'Site source': offer.scraper_source || 'N/A',\n  'Lien direct': offer.url || 'N/A',\n  'Validation IA': offer.ai_response || 'VALIDE',\n  'Statut': offer.status || '‚úÖ VALID√âE',\n  'Date traitement': new Date(offer.processed_at).toLocaleDateString('fr-FR'),\n  'Description': (offer.description || '').substring(0, 200) + '...' // Limit√© pour Excel\n};\n\nconsole.log(`üìä Formatage Excel: ${excelRow.Titre}`);\n\nreturn { json: excelRow };"
      },
      "id": "format-excel",
      "name": "Format Excel",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 180]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "offres_excel",
        "options": {}
      },
      "id": "aggregate-excel",
      "name": "Agr√©ger pour Excel",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [1120, 180]
    },
    {
      "parameters": {
        "functionCode": "// Pr√©paration fichier Excel final\nconst offers = $json.offres_excel || [];\nconst timestamp = new Date().toISOString().slice(0,19).replace(/[:-]/g, '');\nconst filename = `alternance_cybersecurite_${timestamp}.xlsx`;\n\nconsole.log(`\\nüéØ ====== G√âN√âRATION FICHIER EXCEL ====== üéØ`);\nconsole.log(`üìÖ Date: ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`);\nconsole.log(`üìÑ Fichier: ${filename}`);\nconsole.log(`‚úÖ Total offres: ${offers.length}`);\nconsole.log(`ü§ñ Moteur IA: Mistral Large`);\nconsole.log(``);\n\n// R√©ajustement des num√©ros\nconst excelData = offers.map((offer, index) => ({\n  ...offer,\n  'N¬∞': index + 1\n}));\n\n// Statistiques pour onglet s√©par√©\nconst sites_scrapes = [...new Set(offers.map(o => o['Site source']))];\nconst top_locations = Object.entries(\n  offers.reduce((acc, o) => {\n    const loc = (o.Localisation || 'Paris').split('(')[0].trim();\n    acc[loc] = (acc[loc] || 0) + 1;\n    return acc;\n  }, {})\n).sort((a,b) => b[1] - a[1]);\n\nconst statsData = [\n  { 'M√©trique': 'Total offres valid√©es', 'Valeur': offers.length },\n  { 'M√©trique': 'Sites scrap√©s', 'Valeur': sites_scrapes.length },\n  { 'M√©trique': 'Moteur IA', 'Valeur': 'Mistral Large' },\n  { 'M√©trique': 'Date g√©n√©ration', 'Valeur': new Date().toLocaleDateString('fr-FR') },\n  { 'M√©trique': 'Heure g√©n√©ration', 'Valeur': new Date().toLocaleTimeString('fr-FR') }\n];\n\n// Locations pour onglet s√©par√©\nconst locationsData = top_locations.map(([ville, count]) => ({\n  'Ville': ville,\n  'Nombre d\\'offres': count,\n  'Pourcentage': Math.round((count / offers.length) * 100) + '%'\n}));\n\nconsole.log(`üåê Sites scrap√©s: ${sites_scrapes.join(', ')}`);\nconsole.log(`üèÜ Top locations: ${top_locations.map(l => `${l[0]} (${l[1]})`).join(', ')}`);\nconsole.log(``);\nconsole.log(`üìã DONN√âES EXCEL PR√âPAR√âES:`);\nexcelData.forEach(offer => {\n  console.log(`   ${offer['N¬∞']}. ${offer.Titre} - ${offer.Entreprise}`);\n});\nconsole.log(``);\nconsole.log(`üíæ Fichier Excel pr√™t √† g√©n√©rer: ${filename}`);\nconsole.log(`üéØ ======================================= üéØ`);\n\nconst result = {\n  filename: filename,\n  excel_data: excelData,\n  stats_data: statsData,\n  locations_data: locationsData,\n  total_offres: offers.length,\n  sites_scrapes: sites_scrapes,\n  generation_date: new Date().toISOString()\n};\n\nreturn [{ json: result }];"
      },
      "id": "prepare-excel-file",
      "name": "Pr√©parer Fichier Excel",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 180]
    },
    {
      "parameters": {
        "operation": "fromJson",
        "mode": "multipletables",
        "tables": {
          "tables": [
            {
              "tableName": "Offres_Alternance",
              "tableData": "={{ $json.excel_data }}"
            },
            {
              "tableName": "Statistiques",
              "tableData": "={{ $json.stats_data }}"
            },
            {
              "tableName": "Localisations",
              "tableData": "={{ $json.locations_data }}"
            }
          ]
        },
        "options": {}
      },
      "id": "create-excel",
      "name": "Cr√©er Excel",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 2,
      "position": [1560, 180]
    },
    {
      "parameters": {
        "functionCode": "// Log final avec instructions\nconst excelBinary = $binary;\nconst originalData = $input.first()?.json || {};\n\nconsole.log(`\\n‚úÖ ====== FICHIER EXCEL G√âN√âR√â ====== ‚úÖ`);\nconsole.log(`üìÑ Nom du fichier: ${originalData.filename}`);\nconsole.log(`üìä Taille du fichier: ${Object.keys(excelBinary).length > 0 ? 'G√©n√©r√© avec succ√®s' : 'Erreur'}`);\nconsole.log(`‚úÖ Total offres: ${originalData.total_offres}`);\nconsole.log(``);\nconsole.log(`üìã CONTENU DU FICHIER EXCEL:`);\nconsole.log(`   üìë Onglet 1: Offres_Alternance (${originalData.total_offres} lignes)`);\nconsole.log(`   üìä Onglet 2: Statistiques (${originalData.stats_data?.length || 0} m√©triques)`);\nconsole.log(`   üèÜ Onglet 3: Localisations (r√©partition par ville)`);\nconsole.log(``);\nconsole.log(`üíæ T√âL√âCHARGEMENT:`);\nconsole.log(`   1. Allez dans l'onglet 'Output' de ce n≈ìud`);\nconsole.log(`   2. Cliquez sur 'Download binary file'`);\nconsole.log(`   3. Le fichier sera t√©l√©charg√© automatiquement`);\nconsole.log(``);\nconsole.log(`üìß ALTERNATIVE:`);\nconsole.log(`   - Ouvrez le fichier Excel`);\nconsole.log(`   - Copiez les donn√©es`);\nconsole.log(`   - Envoyez par email √† bigmoletos@yopmail.com`);\nconsole.log(``);\nconsole.log(`‚úÖ ====== SUCC√àS ====== ‚úÖ`);\n\nconst result = {\n  filename: originalData.filename,\n  status: 'Excel g√©n√©r√© avec succ√®s',\n  download_instructions: 'Consultez l\\'onglet Output pour t√©l√©charger',\n  excel_ready: true\n};\n\nreturn { json: result };"
      },
      "id": "excel-success",
      "name": "Excel Pr√™t",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 180]
    },
    {
      "parameters": {
        "functionCode": "// Log des rejets\nconst rejectedOffer = $json;\n\nconst logEntry = {\n  titre: rejectedOffer.title,\n  entreprise: rejectedOffer.company,\n  raison_rejet: rejectedOffer.ai_response,\n  date_rejet: new Date().toISOString()\n};\n\nconsole.log('‚ùå Offre rejet√©e (exclue du Excel):', JSON.stringify(logEntry, null, 2));\n\nreturn { json: logEntry };"
      },
      "id": "log-rejected-excel",
      "name": "Log Rejets",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 320]
    }
  ],
  "connections": {
    "D√©clencheur Test (15min)": {
      "main": [
        [
          {
            "node": "Donn√©es Enrichies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Donn√©es Enrichies": {
      "main": [
        [
          {
            "node": "Filtrer Valid√©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrer Valid√©es": {
      "main": [
        [
          {
            "node": "Format Excel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Excel": {
      "main": [
        [
          {
            "node": "Agr√©ger pour Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agr√©ger pour Excel": {
      "main": [
        [
          {
            "node": "Pr√©parer Fichier Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pr√©parer Fichier Excel": {
      "main": [
        [
          {
            "node": "Cr√©er Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cr√©er Excel": {
      "main": [
        [
          {
            "node": "Excel Pr√™t",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "id": "excel-output",
      "name": "Excel Output"
    }
  ],
  "triggerCount": 1
}