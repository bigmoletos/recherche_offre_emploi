{
  "name": "Classification Mistral - PRODUCTION CORRIG√âE",
  "nodes": [
    {
      "parameters": {},
      "id": "start-production-fixed",
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// G√âN√âRATEUR D'OFFRES TEST AVEC CORRECTIONS\nconsole.log('üß™ === G√âN√âRATION OFFRES TEST CORRIG√âES ===');\n\nconst offresTest = [\n  {\n    id: 'test-valide-1',\n    title: 'Contrat d\\'apprentissage - Analyste Cybers√©curit√© SOC',\n    company: 'Orange Cyberdefense',\n    description: 'Contrat d\\'apprentissage de 24 mois pour former un analyste cybers√©curit√© au sein de notre SOC. Missions : surveillance des syst√®mes, analyse incidents de s√©curit√©, r√©ponse aux alertes SIEM.',\n    location: 'Paris, France',\n    contract_type: 'Contrat d\\'apprentissage',\n    keywords: ['apprentissage', 'cybers√©curit√©', 'SOC', 'alternance'],\n    attendu: 'VALIDE'\n  },\n  {\n    id: 'test-invalide-1',\n    title: 'Stage - Marketing Digital et Communication',\n    company: 'AgenceComm',\n    description: 'Stage de 6 mois en marketing digital. Missions : gestion des r√©seaux sociaux, cr√©ation de contenu, campagnes publicitaires.',\n    location: 'Lyon, France',\n    contract_type: 'Stage',\n    keywords: ['stage', 'marketing', 'digital'],\n    attendu: 'INVALIDE'\n  }\n];\n\nconsole.log('üìã Offres test g√©n√©r√©es:', offresTest.length);\noffresTest.forEach((offre, index) => {\n  console.log(`${index + 1}. ${offre.title} ‚Üí ${offre.attendu}`);\n});\n\nreturn offresTest.map(offre => ({ json: offre }));"
      },
      "id": "generator-fixed",
      "name": "üß™ G√©n√©rateur Corrig√©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// PR√âPARATION PAYLOAD MISTRAL AVEC URL CORRECTE\nconst offre = $input.item.json;\n\nconsole.log(`ü§ñ === PR√âPARATION MISTRAL: ${offre.title} ===`);\nconsole.log('üéØ R√©sultat attendu:', offre.attendu);\n\nconst prompt = `ANALYSE CETTE OFFRE D'EMPLOI :\n\nTITRE: ${offre.title}\nENTREPRISE: ${offre.company}\nTYPE: ${offre.contract_type}\nDESCRIPTION: ${offre.description}\n\nCRIT√àRES DE VALIDATION :\n1. CONTRAT = apprentissage OU alternance OU contrat pro\n2. DOMAINE = cybers√©curit√© OU s√©curit√© informatique\n\nR√âPONDS UNIQUEMENT PAR :\n- CLASSIFICATION: VALIDE (si les 2 crit√®res sont remplis)\n- CLASSIFICATION: INVALIDE (sinon)\n- JUSTIFICATION: [explique pourquoi]`;\n\nconst payload = {\n  model: \"mistral-large-latest\",\n  messages: [\n    {\n      role: \"system\",\n      content: \"Tu es un classificateur pr√©cis. Tu r√©ponds toujours avec le format exact demand√©.\"\n    },\n    {\n      role: \"user\",\n      content: prompt\n    }\n  ],\n  temperature: 0.05,\n  max_tokens: 200\n};\n\nconsole.log('üìã Payload cr√©√© pour Mistral');\n\nreturn {\n  json: {\n    ...offre,\n    payload_string: JSON.stringify(payload),\n    processing_index: $itemIndex\n  }\n};"
      },
      "id": "prepare-payload-fixed",
      "name": "üìã Pr√©parer Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.mistral.ai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer fe8GdBIIBwYk8Dj1GvclASPE3j0Zbt95"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "body": "={{ $json.payload_string }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "call-mistral-fixed",
      "name": "üåê Appel Mistral CORRIG√â",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 300],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// TRAITEMENT SUCC√àS - CLASSIFICATION AVEC TYPES CORRECTS\nconst originalData = $('üìã Pr√©parer Payload').item.json;\nconst apiResponse = $input.item.json;\n\nconsole.log(`‚úÖ === TRAITEMENT SUCC√àS: ${originalData.title} ===`);\nconsole.log('üéØ R√©sultat attendu:', originalData.attendu);\n\nif (apiResponse.choices && apiResponse.choices[0] && apiResponse.choices[0].message) {\n  const content = apiResponse.choices[0].message.content.trim();\n  console.log(`üìù R√©ponse Mistral:`, content);\n\n  // CLASSIFICATION AVEC GESTION STRICTE DES TYPES\n  let classification = 'INCERTAIN';\n  let confidence = 0.5; // NOMBRE, pas string\n  let isValid = false; // BOOLEAN, pas string\n  \n  // Patterns pr√©cis\n  const validPattern = /CLASSIFICATION:\\s*VALIDE/i;\n  const invalidPattern = /CLASSIFICATION:\\s*INVALIDE/i;\n  \n  if (validPattern.test(content) && !invalidPattern.test(content)) {\n    classification = 'VALIDE';\n    isValid = true;\n    confidence = 0.95;\n    console.log(`‚úÖ CLASS√â VALIDE`);\n  } else if (invalidPattern.test(content)) {\n    classification = 'INVALIDE';\n    isValid = false;\n    confidence = 0.95;\n    console.log(`‚ùå CLASS√â INVALIDE`);\n  } else {\n    classification = 'INCERTAIN';\n    isValid = false;\n    confidence = 0.3;\n    console.log(`‚ö†Ô∏è CLASSIFICATION INCERTAINE`);\n  }\n\n  // V√©rification avec le r√©sultat attendu\n  const isCorrect = classification === originalData.attendu;\n  console.log(`üéØ Attendu: ${originalData.attendu}, Obtenu: ${classification}, Correct: ${isCorrect}`);\n\n  return {\n    json: {\n      ...originalData,\n      mistral_response: content,\n      classification: classification,\n      is_valid: isValid, // Boolean\n      confidence: confidence, // Number\n      is_correct: isCorrect, // Boolean\n      model_used: apiResponse.model || 'mistral-large-latest',\n      usage: apiResponse.usage || {},\n      processed_at: new Date().toISOString(),\n      status: 'SUCCESS'\n    }\n  };\n} else {\n  console.log(`‚ùå Structure r√©ponse API invalide`);\n  return {\n    json: {\n      ...originalData,\n      mistral_response: 'STRUCTURE_INVALIDE',\n      classification: 'ERREUR',\n      is_valid: false, // Boolean\n      confidence: 0, // Number\n      is_correct: false, // Boolean\n      processed_at: new Date().toISOString(),\n      status: 'ERROR_STRUCTURE'\n    }\n  };\n}"
      },
      "id": "process-success-fixed",
      "name": "‚úÖ Traiter Succ√®s",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// TRAITEMENT ERREUR - AVEC TYPES CORRECTS\nconst originalData = $('üìã Pr√©parer Payload').item.json;\nconst errorData = $input.item;\n\nconsole.log(`‚ùå === ERREUR POUR: ${originalData.title} ===`);\nconsole.log('üîç Erreur compl√®te:', JSON.stringify(errorData, null, 2));\n\n// Analyser l'erreur sp√©cifiquement\nlet errorType = 'UNKNOWN';\nlet suggestion = 'V√©rifier manuellement';\n\nif (errorData.httpCode === 422) {\n  errorType = 'VALIDATION_ERROR';\n  if (errorData.message && errorData.message.includes('messages')) {\n    suggestion = 'Champ messages manquant dans le payload';\n  }\n} else if (errorData.httpCode === 401) {\n  errorType = 'AUTH_ERROR';\n  suggestion = 'Cl√© API invalide ou expir√©e';\n} else if (errorData.httpCode === 404) {\n  errorType = 'ENDPOINT_NOT_FOUND';\n  suggestion = 'URL API Mistral incorrecte - v√©rifier endpoint';\n} else if (errorData.httpCode === 429) {\n  errorType = 'RATE_LIMIT';\n  suggestion = 'Trop de requ√™tes, attendre et r√©essayer';\n}\n\nconsole.log('üè∑Ô∏è Type d\\'erreur:', errorType);\nconsole.log('üí° Suggestion:', suggestion);\n\nreturn {\n  json: {\n    ...originalData,\n    mistral_response: 'ERREUR_API',\n    classification: 'ERREUR',\n    is_valid: false, // Boolean\n    confidence: 0, // Number\n    is_correct: false, // Boolean\n    error_type: errorType,\n    error_code: errorData.httpCode,\n    error_message: errorData.message,\n    suggestion: suggestion,\n    processed_at: new Date().toISOString(),\n    status: 'ERROR'\n  }\n};"
      },
      "id": "process-error-fixed",
      "name": "‚ùå Traiter Erreur",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-valid-fixed",
              "leftValue": "={{ $json.classification }}",
              "rightValue": "VALIDE",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-valid-fixed",
      "name": "Classification ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "action-valid-fixed",
              "name": "action",
              "value": "OFFRE_ACCEPTEE",
              "type": "string"
            },
            {
              "id": "message-valid-fixed",
              "name": "message",
              "value": "‚úÖ {{ $json.title }} - VALID√âE",
              "type": "string"
            },
            {
              "id": "check-valid-fixed-result",
              "name": "verification",
              "value": "Attendu: {{ $json.attendu }}, Obtenu: {{ $json.classification }}, Correct: {{ $json.is_correct }}",
              "type": "string"
            },
            {
              "id": "summary-valid-fixed",
              "name": "summary",
              "value": "{{ $json.company }} | {{ $json.contract_type }} | Cybers√©curit√©: ‚úÖ",
              "type": "string"
            },
            {
              "id": "confidence-fixed",
              "name": "quality_score",
              "value": "={{ $json.confidence }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "result-valid-fixed",
      "name": "‚úÖ Offre Valide",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "action-invalid-fixed",
              "name": "action",
              "value": "OFFRE_REJETEE",
              "type": "string"
            },
            {
              "id": "message-invalid-fixed",
              "name": "message",
              "value": "‚ùå {{ $json.title }} - REJET√âE ({{ $json.classification }})",
              "type": "string"
            },
            {
              "id": "check-invalid-fixed",
              "name": "verification",
              "value": "Attendu: {{ $json.attendu }}, Obtenu: {{ $json.classification }}, Correct: {{ $json.is_correct }}",
              "type": "string"
            },
            {
              "id": "summary-invalid-fixed",
              "name": "summary",
              "value": "{{ $json.company }} | {{ $json.contract_type }} | Raison: {{ $json.classification }}",
              "type": "string"
            },
            {
              "id": "confidence-rejected-fixed",
              "name": "quality_score",
              "value": "={{ $json.confidence }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "result-invalid-fixed",
      "name": "‚ùå Offre Rejet√©e",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1560, 400]
    }
  ],
  "pinData": {},
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "üß™ G√©n√©rateur Corrig√©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üß™ G√©n√©rateur Corrig√©": {
      "main": [
        [
          {
            "node": "üìã Pr√©parer Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Pr√©parer Payload": {
      "main": [
        [
          {
            "node": "üåê Appel Mistral CORRIG√â",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üåê Appel Mistral CORRIG√â": {
      "main": [
        [
          {
            "node": "‚úÖ Traiter Succ√®s",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "‚ùå Traiter Erreur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Traiter Succ√®s": {
      "main": [
        [
          {
            "node": "Classification ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùå Traiter Erreur": {
      "main": [
        [
          {
            "node": "Classification ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classification ?": {
      "main": [
        [
          {
            "node": "‚úÖ Offre Valide",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå Offre Rejet√©e",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  },
  "versionId": "production-fixed-v1",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "workflow-production-fixed",
  "tags": ["production", "fixed", "classification", "corrected"]
}