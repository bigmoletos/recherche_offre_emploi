{
  "name": "TEST - Nouvelle ClÃ© Mistral (Variables ENV)",
  "nodes": [
    {
      "parameters": {},
      "id": "start-test-new-key",
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// TEST NOUVELLE CLÃ‰ MISTRAL DEPUIS ENV\nconsole.log('ğŸ”‘ === TEST NOUVELLE CLÃ‰ MISTRAL ===');\n\n// RÃ©cupÃ©ration clÃ© depuis variables d'environnement\nconst mistralKey = $env.mistral_key_site_emploi;\n\nif (!mistralKey) {\n  console.log('âŒ ERREUR: Variable mistral_key_site_emploi non trouvÃ©e');\n  console.log('ğŸ”§ VÃ©rifiez que la clÃ© est bien dans le fichier .env');\n  return [{\n    json: {\n      error: 'MISSING_ENV_VAR',\n      message: 'Variable mistral_key_site_emploi introuvable',\n      recommendation: 'VÃ©rifier fichier .env et redÃ©marrer N8N'\n    }\n  }];\n}\n\nconsole.log('âœ… ClÃ© Mistral trouvÃ©e:', mistralKey.substring(0, 8) + '...');\nconsole.log('ğŸ“ Longueur clÃ©:', mistralKey.length, 'caractÃ¨res');\n\n// Tests avec diffÃ©rents niveaux de complexitÃ©\nconst testsOffres = [\n  {\n    id: 'test-simple-1',\n    title: 'Contrat d\\'apprentissage - Analyste CybersÃ©curitÃ© SOC',\n    company: 'Orange Cyberdefense',\n    description: 'Formation alternance 24 mois analyste cybersÃ©curitÃ© SOC.',\n    contract_type: 'Contrat d\\'apprentissage',\n    attendu: 'VALIDE',\n    complexite: 'SIMPLE'\n  },\n  {\n    id: 'test-complexe-1',\n    title: 'Apprentissage - Commercial Solutions Cyber B2B',\n    company: 'CyberVente Corp',\n    description: 'Contrat apprentissage commercial spÃ©cialisÃ© vente solutions cybersÃ©curitÃ© entreprises.',\n    contract_type: 'Contrat d\\'apprentissage',\n    attendu: 'INVALIDE',\n    complexite: 'COMPLEXE'\n  },\n  {\n    id: 'test-limite-1',\n    title: 'Stage - Pentester Junior',\n    company: 'SecuriTest',\n    description: 'Stage 6 mois pentesting et audit sÃ©curitÃ© systÃ¨mes informatiques.',\n    contract_type: 'Stage',\n    attendu: 'INVALIDE',\n    complexite: 'LIMITE'\n  }\n];\n\nconsole.log('ğŸ“‹ Tests prÃ©parÃ©s:', testsOffres.length);\n\nreturn testsOffres.map(test => {\n  const prompt = `ANALYSE OFFRE ALTERNANCE CYBERSÃ‰CURITÃ‰:\n\nTITRE: ${test.title}\nENTREPRISE: ${test.company}\nCONTRAT: ${test.contract_type}\nDESCRIPTION: ${test.description}\n\nCRITÃˆRES VALIDATION:\nâœ… CONTRAT = apprentissage OU alternance OU contrat pro\nâœ… DOMAINE = cybersÃ©curitÃ© OU sÃ©curitÃ© informatique\nâŒ EXCLURE = stage, CDI, CDD, commercial, marketing\n\nRÃ‰PONDS EXACTEMENT:\nCLASSIFICATION: VALIDE ou INVALIDE\nJUSTIFICATION: [raison courte]`;\n\n  const payload = {\n    model: \"mistral-large-latest\",\n    messages: [\n      {\n        role: \"system\",\n        content: \"Tu es un expert en classification d'offres d'alternance cybersÃ©curitÃ©. Tu appliques des critÃ¨res stricts et rÃ©ponds avec le format exact demandÃ©.\"\n      },\n      {\n        role: \"user\",\n        content: prompt\n      }\n    ],\n    temperature: 0.05,\n    max_tokens: 150\n  };\n\n  return {\n    json: {\n      ...test,\n      mistral_key: mistralKey,\n      payload_string: JSON.stringify(payload),\n      prompt_used: prompt,\n      api_url: 'https://api.mistral.ai/v1/chat/completions',\n      test_timestamp: new Date().toISOString()\n    }\n  };\n});"
      },
      "id": "prepare-tests-new-key",
      "name": "ğŸ”‘ PrÃ©parer Tests Nouvelle ClÃ©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.api_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $json.mistral_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "User-Agent",
              "value": "n8n-emploi-cybersecurite/1.0"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "body": "={{ $json.payload_string }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "call-mistral-new-key",
      "name": "ğŸŒ Appel Mistral Nouvelle ClÃ©",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 300],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// TRAITEMENT SUCCÃˆS MISTRAL\nconst testData = $('ğŸ”‘ PrÃ©parer Tests Nouvelle ClÃ©').item.json;\nconst apiResponse = $input.item.json;\n\nconsole.log(`âœ… === SUCCÃˆS MISTRAL: ${testData.title} ===`);\nconsole.log('ğŸ¯ ComplexitÃ© test:', testData.complexite);\nconsole.log('ğŸ¯ RÃ©sultat attendu:', testData.attendu);\n\nlet classification = 'ERREUR';\nlet justification = 'RÃ©ponse API invalide';\nlet confidence = 0;\n\nif (apiResponse && apiResponse.choices && apiResponse.choices[0] && apiResponse.choices[0].message) {\n  const content = apiResponse.choices[0].message.content.trim();\n  console.log('ğŸ“ RÃ©ponse Mistral:', content);\n\n  // EXTRACTION CLASSIFICATION\n  const validMatch = content.match(/CLASSIFICATION:\\s*(VALIDE)/i);\n  const invalidMatch = content.match(/CLASSIFICATION:\\s*(INVALIDE)/i);\n  \n  if (validMatch && !invalidMatch) {\n    classification = 'VALIDE';\n    confidence = 0.95;\n  } else if (invalidMatch) {\n    classification = 'INVALIDE';\n    confidence = 0.95;\n  } else {\n    classification = 'INCERTAIN';\n    confidence = 0.3;\n  }\n\n  // EXTRACTION JUSTIFICATION\n  const justifMatch = content.match(/JUSTIFICATION:\\s*(.+)/i);\n  if (justifMatch) {\n    justification = justifMatch[1].trim();\n  } else {\n    justification = 'Justification non extraite';\n  }\n} else {\n  console.log('âŒ Structure rÃ©ponse API invalide');\n}\n\nconst isCorrect = classification === testData.attendu;\nconst resultIcon = isCorrect ? 'âœ…' : 'âŒ';\n\nconsole.log(`${resultIcon} Classification: ${classification}`);\nconsole.log(`ğŸ¯ Attendu: ${testData.attendu}, Obtenu: ${classification}`);\nconsole.log(`ğŸ’¡ Justification: ${justification}`);\n\nreturn {\n  json: {\n    ...testData,\n    mistral_result: {\n      classification: classification,\n      justification: justification,\n      confidence: confidence,\n      is_correct: isCorrect,\n      api_response_valid: true,\n      raw_content: apiResponse.choices[0].message.content,\n      model_used: apiResponse.model,\n      tokens_used: apiResponse.usage\n    },\n    test_status: 'SUCCESS',\n    processed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "process-mistral-success",
      "name": "âœ… Traiter SuccÃ¨s Mistral",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "jsCode": "// TRAITEMENT ERREUR MISTRAL\nconst testData = $('ğŸ”‘ PrÃ©parer Tests Nouvelle ClÃ©').item.json;\nconst errorData = $input.item;\n\nconsole.log(`âŒ === ERREUR MISTRAL: ${testData.title} ===`);\nconsole.log('ğŸ” Code erreur:', errorData.httpCode);\nconsole.log('ğŸ“‹ Message:', errorData.message);\n\nlet diagnostic = 'Erreur inconnue';\nlet solution = 'Investiguer manuellement';\nlet severite = 'MEDIUM';\n\nswitch(errorData.httpCode) {\n  case 401:\n    diagnostic = 'ClÃ© API invalide ou expirÃ©e';\n    solution = 'VÃ©rifier la clÃ© dans les variables d\\'environnement';\n    severite = 'HIGH';\n    break;\n  case 422:\n    diagnostic = 'Payload invalide';\n    solution = 'VÃ©rifier structure JSON des messages';\n    severite = 'MEDIUM';\n    break;\n  case 404:\n    diagnostic = 'Endpoint API incorrect';\n    solution = 'VÃ©rifier URL API Mistral';\n    severite = 'HIGH';\n    break;\n  case 429:\n    diagnostic = 'Limite de taux dÃ©passÃ©e';\n    solution = 'Attendre et rÃ©essayer, ou upgrader plan';\n    severite = 'LOW';\n    break;\n  case 500:\n    diagnostic = 'Erreur serveur Mistral';\n    solution = 'RÃ©essayer plus tard';\n    severite = 'MEDIUM';\n    break;\n}\n\nconsole.log('ğŸ·ï¸ Diagnostic:', diagnostic);\nconsole.log('ğŸ’¡ Solution:', solution);\nconsole.log('âš ï¸ SÃ©vÃ©ritÃ©:', severite);\n\nreturn {\n  json: {\n    ...testData,\n    mistral_result: {\n      classification: 'ERREUR_API',\n      justification: diagnostic,\n      confidence: 0,\n      is_correct: false,\n      api_response_valid: false,\n      error_details: {\n        code: errorData.httpCode,\n        message: errorData.message,\n        diagnostic: diagnostic,\n        solution: solution,\n        severite: severite\n      }\n    },\n    test_status: 'ERROR',\n    processed_at: new Date().toISOString()\n  }\n};"
      },
      "id": "process-mistral-error",
      "name": "âŒ Traiter Erreur Mistral",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "jsCode": "// COMPARAISON MISTRAL VS CLASSIFICATION LOCALE\nconst mistralResults = [...$('âœ… Traiter SuccÃ¨s Mistral').all(), ...$('âŒ Traiter Erreur Mistral').all()];\n\nconsole.log('ğŸ“Š === COMPARAISON FINALE ===');\nconsole.log('ğŸ”¢ Total tests:', mistralResults.length);\n\nlet mistralCorrects = 0;\nlet mistralErrors = 0;\nlet totalValid = 0;\n\nconst detailsTests = mistralResults.map(item => {\n  const data = item.json;\n  const isSuccess = data.test_status === 'SUCCESS';\n  const isCorrect = data.mistral_result.is_correct;\n  \n  if (isSuccess) {\n    if (isCorrect) mistralCorrects++;\n    totalValid++;\n  } else {\n    mistralErrors++;\n  }\n\n  return {\n    test_id: data.id,\n    titre: data.title,\n    complexite: data.complexite,\n    attendu: data.attendu,\n    mistral_classification: data.mistral_result.classification,\n    mistral_correct: isCorrect,\n    mistral_confidence: data.mistral_result.confidence,\n    mistral_justification: data.mistral_result.justification,\n    status: data.test_status\n  };\n});\n\nconst mistralPrecision = totalValid > 0 ? (mistralCorrects / totalValid * 100).toFixed(1) : 0;\nconst mistralDisponibilite = mistralResults.length > 0 ? ((totalValid / mistralResults.length) * 100).toFixed(1) : 0;\n\nconsole.log('ğŸ“ˆ RÃ‰SULTATS MISTRAL:');\nconsole.log(`âœ… SuccÃ¨s: ${totalValid}/${mistralResults.length}`);\nconsole.log(`ğŸ¯ PrÃ©cision: ${mistralCorrects}/${totalValid} = ${mistralPrecision}%`);\nconsole.log(`âš¡ DisponibilitÃ©: ${mistralDisponibilite}%`);\nconsole.log(`âŒ Erreurs API: ${mistralErrors}`);\n\n// SIMULATION CLASSIFICATION LOCALE POUR COMPARAISON\nconst localeResults = detailsTests.map(test => {\n  const texte = `${test.titre} ${test.attendu}`.toLowerCase();\n  const hasAlternance = /apprentissage|alternance|contrat pro/.test(texte);\n  const hasCyber = /cybersÃ©curitÃ©|cyber|sÃ©curitÃ© informatique|soc|siem/.test(texte);\n  const hasExclusif = /stage|cdi|cdd|commercial|marketing/.test(texte);\n  \n  let localeClassif = 'INCERTAIN';\n  if (hasAlternance && hasCyber && !hasExclusif) {\n    localeClassif = 'VALIDE';\n  } else if (hasExclusif || !hasAlternance || !hasCyber) {\n    localeClassif = 'INVALIDE';\n  }\n  \n  return {\n    ...test,\n    locale_classification: localeClassif,\n    locale_correct: localeClassif === test.attendu\n  };\n});\n\nconst localeCorrects = localeResults.filter(r => r.locale_correct).length;\nconst localePrecision = (localeCorrects / localeResults.length * 100).toFixed(1);\n\nconsole.log('\\nğŸ“ˆ COMPARAISON FINALE:');\nconsole.log(`ğŸ¤– Mistral: ${mistralPrecision}% prÃ©cision (${mistralDisponibilite}% disponibilitÃ©)`);\nconsole.log(`ğŸ’» Locale: ${localePrecision}% prÃ©cision (100% disponibilitÃ©)`);\n\nconst recommendation = parseFloat(mistralPrecision) > parseFloat(localePrecision) && parseFloat(mistralDisponibilite) > 90 ?\n  'UTILISER_MISTRAL' : 'UTILISER_LOCALE';\n\nreturn {\n  json: {\n    rapport_final: {\n      total_tests: mistralResults.length,\n      mistral_stats: {\n        precision: `${mistralPrecision}%`,\n        disponibilite: `${mistralDisponibilite}%`,\n        erreurs: mistralErrors,\n        succÃ¨s: totalValid\n      },\n      locale_stats: {\n        precision: `${localePrecision}%`,\n        disponibilite: '100%',\n        erreurs: 0,\n        succÃ¨s: localeResults.length\n      },\n      recommendation: recommendation,\n      details_tests: localeResults\n    },\n    genere_le: new Date().toISOString()\n  }\n};"
      },
      "id": "comparaison-finale",
      "name": "ğŸ“Š Comparaison Mistral vs Locale",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    }
  ],
  "pinData": {},
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "ğŸ”‘ PrÃ©parer Tests Nouvelle ClÃ©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”‘ PrÃ©parer Tests Nouvelle ClÃ©": {
      "main": [
        [
          {
            "node": "ğŸŒ Appel Mistral Nouvelle ClÃ©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸŒ Appel Mistral Nouvelle ClÃ©": {
      "main": [
        [
          {
            "node": "âœ… Traiter SuccÃ¨s Mistral",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "âŒ Traiter Erreur Mistral",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Traiter SuccÃ¨s Mistral": {
      "main": [
        [
          {
            "node": "ğŸ“Š Comparaison Mistral vs Locale",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âŒ Traiter Erreur Mistral": {
      "main": [
        [
          {
            "node": "ğŸ“Š Comparaison Mistral vs Locale",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  },
  "versionId": "test-new-key-v1",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "workflow-test-nouvelle-cle-mistral",
  "tags": ["test", "mistral", "nouvelle-cle", "env-vars"]
}